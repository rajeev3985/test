name: Deploy CloudFormation

on:
  workflow_dispatch:
    inputs:
      stack_name:
        description: "CloudFormation stack name"
        required: true
        default: "my-app"
      template:
        description: "Path/URL to template (YAML/JSON)"
        required: true
        default: "infra/template.yml"
      parameters:
        description: "Comma-separated key=value list (optional)"
        required: false
        default: ""
      region:
        description: "AWS region"
        required: true
        default: "us-east-1"
      capabilities:
        description: "Capabilities (e.g., CAPABILITY_NAMED_IAM)"
        required: false
        default: "CAPABILITY_IAM CAPABILITY_NAMED_IAM"

permissions:
  id-token: write   # required for GitHub OIDC to AWS
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    # (Optional) Require manual approval via GitHub Environments:
    # environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<AWS_ACCOUNT_ID>:role/<ROLE_NAME_WITH_TRUST_TO_GITHUB>
          aws-region: ${{ github.event.inputs.region }}

      - name: Show AWS caller identity (sanity check)
        run: aws sts get-caller-identity

      - name: Package parameters
        id: params
        shell: bash
        run: |
          # Convert "Key=Value,Key2=Value2" -> --parameter-overrides Key=Value Key2=Value2
          if [[ -n "${{ github.event.inputs.parameters }}" ]]; then
            P=$(echo "${{ github.event.inputs.parameters }}" | sed 's/,/ /g')
            echo "args=--parameter-overrides $P" >> "$GITHUB_OUTPUT"
          else
            echo "args=" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy stack
        shell: bash
        run: |
          set -euo pipefail
          aws cloudformation deploy \
            --stack-name "${{ github.event.inputs.stack_name }}" \
            --template-file "${{ github.event.inputs.template }}" \
            --capabilities ${{ github.event.inputs.capabilities }} \
            ${{ steps.params.outputs.args }} \
            --no-fail-on-empty-changeset
